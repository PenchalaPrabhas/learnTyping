<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Test with Timer and Error Handling</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
            text-align: center;
            margin-top: 50px;
        }
        #word-container {
            display: flex;
            justify-content: center;
            font-size: 2em;
            margin-bottom: 20px;
            gap: 30px;
        }
        .word {
            min-width: 100px;
            color: white;
            text-shadow: 0 0 10px white;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
            text-shadow: none;
        }
        #stats {
            margin-top: 20px;
        }
        #timer {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        #go-back {
            display: inline-block;
            padding: 10px 20px;
            font-size: 1em;
            color: white;
            background-color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        #go-back:hover {
            background-color: #555;
        }
    </style>
</head>
<body>

<div id="timer">Time: 00:00:00</div>

<div id="word-container">
    <span class="word" id="word1">Loading...</span>
    <span class="word" id="word2">Loading...</span>
    <span class="word" id="word3">Loading...</span>
</div>
<div id="stats">
    <div>Words typed: <span id="word-count">0</span></div>
    <div>WPM: <span id="wpm">0</span></div>
</div>

<button id="go-back" onclick="goBack()">Go Back</button>

<script>
    const words = [];
    let wordIndex = 0;
    let currentCharIndex = 0;
    let correctCharacters = 0;
    let wordCount = 0;
    let startTime;
    let elapsedTime = 0;
    let typingTimer;
    let typingActive = true;
    let wordInProgress = true;
    let isWordComplete = false;  // Variable to check if the word is correctly typed

    const wordContainer1 = document.getElementById('word1');
    const wordContainer2 = document.getElementById('word2');
    const wordContainer3 = document.getElementById('word3');
    const wordCountDisplay = document.getElementById('word-count');
    const wpmDisplay = document.getElementById('wpm');
    const timerDisplay = document.getElementById('timer');

    // Fetch random words from API
    async function fetchWords() {
        const response = await fetch('https://random-word-api.herokuapp.com/word?number=3');
        const data = await response.json();
        words.push(...data);
        displayWords();
    }

    // Display the first three words
    function displayWords() {
        wordContainer1.innerText = words[0];
        wordContainer2.innerText = words[1];
        wordContainer3.innerText = words[2];
    }

    // Shift words when one is completed
    function shiftWords() {
        words.shift();  // Remove the first word
        wordContainer1.innerText = words[0];
        wordContainer2.innerText = words[1];
        fetchNewWord();
        currentCharIndex = 0;  // Reset for the next word
        wordInProgress = true; // Allow new word to be processed
        isWordComplete = false; // Reset word completion status
    }

    // Fetch a new word to replace the last word
    async function fetchNewWord() {
        const response = await fetch('https://random-word-api.herokuapp.com/word');
        const data = await response.json();
        words.push(data[0]);
        wordContainer3.innerText = words[2];
    }

    // Format time as hh:mm:ss
    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // Start the timer on the first key press
    function startTimer() {
        startTime = new Date();
        typingTimer = setInterval(() => {
            elapsedTime = Math.floor((new Date() - startTime) / 1000);  // Update elapsed time in seconds
            timerDisplay.innerText = `Time: ${formatTime(elapsedTime)}`;
        }, 1000);
    }

    // Stop the timer
    function stopTimer() {
        clearInterval(typingTimer);
        typingActive = false;
    }

    // Calculate WPM
    function calculateWPM() {
        const timeDiff = elapsedTime / 60;  // time in minutes
        return Math.round((wordCount / timeDiff));
    }

    // Handle key strokes
    document.addEventListener('keydown', function(event) {
        if (!startTime && typingActive) startTimer();  // Start timer on first key press

        const currentWord = words[0];
        const typedChar = event.key;

        // Handle correct character typing
        if (typedChar === currentWord[currentCharIndex]) {
            correctCharacters++;
            currentCharIndex++;

            // No zoom effect; just show the correct part in green
            wordContainer1.innerHTML = '<span class="correct">' + currentWord.slice(0, currentCharIndex) + '</span>' + currentWord.slice(currentCharIndex);

            // Check if the entire word is typed correctly
            if (currentCharIndex === currentWord.length) {
                isWordComplete = true;  // Mark the word as complete
            }
        } else if (typedChar !== " ") {
            // Handle incorrect character typing
            wordInProgress = false;
            wordContainer1.innerHTML = '<span class="correct">' + currentWord.slice(0, currentCharIndex) + '</span><span class="incorrect">' + currentWord[currentCharIndex] + '</span>' + currentWord.slice(currentCharIndex + 1);
        }

        // Handle space key to complete the word and shift only if word is correctly typed
        if (typedChar === " " && isWordComplete) {
            wordCount++;
            wordCountDisplay.innerText = wordCount;
            wpmDisplay.innerText = calculateWPM();  // Update WPM

            shiftWords();  // Shift to the next word
        }

        // Stop timer if Enter is pressed
        if (event.key === "Enter") {
            stopTimer();
        }
    });

    // Function to handle the "Go Back" button click
    function goBack() {
        window.location.href = 'index.html';
    }

    // Initial word fetch
    fetchWords();
</script>

</body>
</html>
